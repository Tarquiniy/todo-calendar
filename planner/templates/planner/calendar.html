{% extends 'planner/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–µ–æ–Ω–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="display-5 fw-bold text-gradient">
        <span class="text-primary">üìÜ</span> –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
      </h1>
      <p class="text-muted">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é</p>
    </div>
    <div class="d-flex gap-2">
      <button id="prevBtn" class="btn btn-outline-primary rounded-pill">
        <i class="bi bi-chevron-left"></i>
      </button>
      <button id="todayBtn" class="btn btn-primary rounded-pill glow-effect">
        <i class="bi bi-calendar-check me-2"></i>–°–µ–≥–æ–¥–Ω—è
      </button>
      <button id="nextBtn" class="btn btn-outline-primary rounded-pill">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- –î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
  <div class="glass-card p-3 mb-4">
    <div class="row g-2">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="calendarSearch" type="text" class="form-control" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á...">
        </div>
      </div>
      <div class="col-md-6">
        <select id="categoryFilter" class="form-select">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å –Ω–µ–æ–Ω–æ–≤—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º -->
  <div class="card shadow-blur mb-4 glass-card">
    <div class="card-header bg-transparent py-3 border-0">
      <div class="d-flex justify-content-between align-items-center">
        <!-- –õ–µ–≥–µ–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å –∏–∫–æ–Ω–∫–∞–º–∏ -->
        <div class="d-flex gap-3 flex-wrap">
          <div class="d-flex align-items-center badge-status">
            <span class="status-indicator bg-primary"></span>
            <span class="ms-2">–ù–æ–≤—ã–µ</span>
          </div>
          <div class="d-flex align-items-center badge-status">
            <span class="status-indicator bg-warning"></span>
            <span class="ms-2">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
          </div>
          <div class="d-flex align-items-center badge-status">
            <span class="status-indicator bg-success"></span>
            <span class="ms-2">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</span>
          </div>
        </div>
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤ -->
        <div class="d-flex gap-2 view-switcher">
          <button id="dayView" class="btn btn-outline-secondary btn-sm rounded-pill">
            <i class="bi bi-sun me-1"></i>–î–µ–Ω—å
          </button>
          <button id="weekView" class="btn btn-primary btn-sm rounded-pill active">
            <i class="bi bi-calendar-week me-1"></i>–ù–µ–¥–µ–ª—è
          </button>
          <button id="monthView" class="btn btn-outline-secondary btn-sm rounded-pill">
            <i class="bi bi-calendar-month me-1"></i>–ú–µ—Å—è—Ü
          </button>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div id="calendar" style="height: 800px;"></div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ —Å—Ç–∏–ª–µ glassmorphism -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card">
      <form id="eventForm" class="needs-validation" novalidate>
        <div class="modal-header border-0">
          <h5 class="modal-title text-gradient" id="modalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="noteId" name="noteId">

          <div class="mb-3">
            <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" name="title" id="title" class="form-control form-control-lg rounded-pill" required>
            <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏</div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">–ù–∞—á–∞–ª–æ</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                <input type="datetime-local" name="start" id="start" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                <input type="datetime-local" name="end" id="end" class="form-control">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea name="content" id="content" class="form-control" rows="3" style="border-radius: 20px;"></textarea>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-list-check"></i></span>
                <select name="status" id="status" class="form-select">
                  <option value="NEW">üÜï –ù–æ–≤—ã–π</option>
                  <option value="IN_PROGRESS">üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                  <option value="DONE">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                <select name="category" id="category" class="form-select">
                  <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                  {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" name="repeat_daily" id="repeat_daily">
            <label class="form-check-label" for="repeat_daily">
              <i class="bi bi-arrow-repeat me-2"></i>–ü–æ–≤—Ç–æ—Ä—è—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
            </label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>–û—Ç–º–µ–Ω–∞
          </button>
          <button type="submit" class="btn btn-primary rounded-pill glow-effect">
            <i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <button type="button" id="deleteBtn" class="btn btn-danger rounded-pill d-none">
            <i class="bi bi-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –†–µ—Å—É—Ä—Å—ã –¥–ª—è FullCalendar -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.18/index.global.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.18/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.18/locales/ru.global.min.js"></script>

<style>
  /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è 2025 –≥–æ–¥–∞ */
  :root {
    --glass-bg: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
    --warning-gradient: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
    --blur-filter: blur(12px);
    --transition-all: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—Ç–µ–∫–ª–∞ (glassmorphism) */
  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: var(--blur-filter);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    border-radius: 20px;
    overflow: hidden;
  }

  .shadow-blur {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
  }

  /* –¢–µ–∫—Å—Ç–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
  .text-gradient {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ */
  .status-indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    box-shadow: 0 0 8px currentColor;
  }

  .badge-status {
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.1);
    transition: var(--transition-all);
  }

  .badge-status:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ */
  .glow-effect {
    position: relative;
    overflow: hidden;
    z-index: 1;
  }

  .glow-effect::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
    z-index: -1;
  }

  .glow-effect:hover::after {
    transform: translateX(0);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
  .fc {
    font-family: 'Segoe UI', system-ui, sans-serif;
  }

  .fc-header-toolbar {
    margin-bottom: 1.5rem !important;
  }

  .fc-event {
    border: none !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: var(--transition-all);
    overflow: hidden;
    padding: 6px 8px !important;
    font-size: 0.9rem;
    cursor: pointer;
  }

  .fc-event:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    z-index: 10 !important;
  }

  .fc-event.NEW {
    background: var(--primary-gradient);
    color: white;
  }

  .fc-event.IN_PROGRESS {
    background: var(--warning-gradient);
    color: #000;
  }

  .fc-event.DONE {
    background: var(--success-gradient);
    color: white;
  }

  .fc-daygrid-event-dot {
    display: none;
  }

  .fc-daygrid-more-link {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.85rem;
    transition: var(--transition-all);
  }

  .fc-daygrid-more-link:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  .fc-popover {
    border-radius: 16px !important;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: none !important;
  }

  .fc-popover-header {
    background: var(--primary-gradient) !important;
    color: white !important;
    border: none !important;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
    }

    .view-switcher {
      width: 100%;
      justify-content: center;
    }

    .fc-toolbar-title {
      font-size: 1.25rem !important;
    }

    #calendar {
      height: 600px !important;
    }
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
  @keyframes modalIn {
    0% { opacity: 0; transform: translateY(30px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal.show .modal-content {
    animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É–ª—Ç–∏–ø–æ–≤ */
  .calendar-tooltip {
    max-width: 300px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const calendarEl = document.getElementById('calendar');
  const modalElement = document.getElementById('eventModal');
  const modal = modalElement ? new bootstrap.Modal(modalElement) : null;
  const form = document.getElementById('eventForm');
  const deleteBtn = document.getElementById('deleteBtn');

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ FullCalendar
  if (typeof FullCalendar === 'undefined') {
    calendarEl.innerHTML = `
      <div class="alert alert-danger">
        <h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</h4>
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É FullCalendar</p>
        <button class="btn btn-primary mt-2" onclick="location.reload()">
          –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        </button>
      </div>
    `;
    return;
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'ru',
    timeZone: 'local',
    initialView: 'timeGridWeek',
    headerToolbar: {
      left: '',
      center: 'title',
      right: ''
    },
    height: 'auto',
    editable: true,
    selectable: true,
    eventResizableFromStart: true,
    eventDurationEditable: true,
    dayMaxEventRows: true,
    eventMinHeight: 30,
    events: function(fetchInfo, successCallback, failureCallback) {
      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      const search = document.getElementById('calendarSearch').value;
      const categoryId = document.getElementById('categoryFilter').value;

      fetch(`/calendar/events/?search=${search}&category=${categoryId}`)
        .then(response => response.json())
        .then(data => successCallback(data))
        .catch(error => failureCallback(error));
    },

    // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    eventContent: function(arg) {
      const event = arg.event;
      const status = event.extendedProps.status;
      const statusIcons = {
        'NEW': 'bi-circle',
        'IN_PROGRESS': 'bi-arrow-repeat',
        'DONE': 'bi-check-circle'
      };
      
      const eventEl = document.createElement('div');
      eventEl.classList.add('fc-event-content');
      
      // –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
      const iconEl = document.createElement('i');
      iconEl.classList.add('bi', statusIcons[status] || 'bi-calendar');
      iconEl.style.marginRight = '5px';
      
      // –í—Ä–µ–º—è
      const timeEl = document.createElement('span');
      timeEl.classList.add('fc-event-time');
      timeEl.textContent = arg.timeText;
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      const titleEl = document.createElement('span');
      titleEl.classList.add('fc-event-title');
      titleEl.textContent = event.title;
      
      eventEl.appendChild(iconEl);
      eventEl.appendChild(timeEl);
      eventEl.appendChild(titleEl);
      
      return { domNodes: [eventEl] };
    },

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    eventClassNames: function(arg) {
      return ['fc-event', arg.event.extendedProps.status];
    },

    // –¶–≤–µ—Ç —Å–æ–±—ã—Ç–∏—è (–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
    eventColor: function(arg) {
      return arg.event.extendedProps.color || null;
    },

    // –í—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    select: function(info) {
      if (!modal) return;

      document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
      form.reset();
      document.getElementById('noteId').value = '';
      deleteBtn.classList.add('d-none');

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
      document.getElementById('start').value = formatDateTimeLocal(info.start);
      document.getElementById('end').value = info.end ? formatDateTimeLocal(info.end) : '';

      modal.show();
    },

    // –ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é
    eventClick: function(info) {
      if (!modal) return;

      const event = info.event;
      fetch(`/calendar/get/${event.id}/`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
          document.getElementById('noteId').value = data.id;
          document.getElementById('title').value = data.title;
          document.getElementById('content').value = data.content;
          document.getElementById('status').value = data.status;
          document.getElementById('repeat_daily').checked = data.repeat_daily;

          if (data.category) {
            document.getElementById('category').value = data.category;
          }

          const startDate = new Date(data.start);
          const endDate = data.end ? new Date(data.end) : new Date(startDate);

          document.getElementById('start').value = formatDateTimeLocal(startDate);
          document.getElementById('end').value = endDate ? formatDateTimeLocal(endDate) : '';

          deleteBtn.classList.remove('d-none');
          modal.show();
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏: ' + error.message);
        });
    },

    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    eventDrop: function(info) {
      updateEventDate(info.event);
    },

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏—è
    eventResize: function(info) {
      updateEventDate(info.event);
    },

    // –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–∏–¥ –¥–ª—è –¥–Ω–µ–π —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–±—ã—Ç–∏–π
    eventDidMount: function(info) {
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
      info.el.style.opacity = 0;
      setTimeout(() => {
        info.el.style.transition = 'opacity 0.5s ease';
        info.el.style.opacity = 1;
      }, 50);

      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É–ª—Ç–∏–ø–∞
      const tooltipContent = `
        <div class="calendar-tooltip">
          <strong>${info.event.title}</strong>
          <div>${info.event.extendedProps.content || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
          <div class="mt-2">
            <i class="bi bi-tag-fill"></i> 
            ${info.event.extendedProps.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
          </div>
        </div>
      `;
      
      new bootstrap.Tooltip(info.el, {
        title: tooltipContent,
        html: true,
        placement: 'top',
        container: 'body'
      });
    }
  });

  calendar.render();

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  document.getElementById('todayBtn')?.addEventListener('click', function() {
    calendar.today();
  });

  document.getElementById('prevBtn')?.addEventListener('click', function() {
    calendar.prev();
  });

  document.getElementById('nextBtn')?.addEventListener('click', function() {
    calendar.next();
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤
  document.getElementById('dayView')?.addEventListener('click', function() {
    calendar.changeView('timeGridDay');
    updateActiveButton(this);
  });

  document.getElementById('weekView')?.addEventListener('click', function() {
    calendar.changeView('timeGridWeek');
    updateActiveButton(this);
  });

  document.getElementById('monthView')?.addEventListener('click', function() {
    calendar.changeView('dayGridMonth');
    updateActiveButton(this);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
  form?.addEventListener('submit', function(e) {
    e.preventDefault();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    if (!form.checkValidity()) {
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    const data = new FormData(form);

    fetch('/calendar/save/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: data
    })
    .then(response => response.json())
    .then(result => {
      if (result.status === 'ok') {
        modal.hide();
        calendar.refetchEvents();
      } else {
        throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É: ' + error.message);
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
  deleteBtn?.addEventListener('click', function() {
    const noteId = document.getElementById('noteId').value;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;

    fetch(`/calendar/delete/${noteId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(result => {
      if (result.status === 'ok') {
        modal.hide();
        calendar.refetchEvents();
      } else {
        throw new Error(result.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É: ' + error.message);
    });
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
  function updateEventDate(event) {
    const eventData = {
      id: event.id,
      start: event.start ? event.start.toISOString() : null,
      end: event.end ? event.end.toISOString() : null
    };

    fetch('/calendar/update_date/' + event.id + '/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(eventData)
    })
    .then(response => response.json())
    .then(result => {
      if (result.status !== 'ok') {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã:', result.message);
        calendar.refetchEvents();
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞:', error);
      calendar.refetchEvents();
    });
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function formatDateTimeLocal(date) {
    const pad = num => num.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function updateActiveButton(activeButton) {
    document.querySelectorAll('#dayView, #weekView, #monthView').forEach(btn => {
      btn.classList.remove('active', 'btn-primary');
      btn.classList.add('btn-outline-secondary');
    });
    activeButton.classList.remove('btn-outline-secondary');
    activeButton.classList.add('active', 'btn-primary');
  }

  // –ü–æ–∏—Å–∫ –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
  document.getElementById('calendarSearch').addEventListener('input', function() {
    calendar.refetchEvents();
  });
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  document.getElementById('categoryFilter').addEventListener('change', function() {
    calendar.refetchEvents();
  });
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–¥–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const savedView = localStorage.getItem('calendarView');
  if (savedView) {
    calendar.changeView(savedView);
  }
  
  calendar.on('viewDidMount', function() {
    localStorage.setItem('calendarView', calendar.view.type);
  });

  // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  document.querySelectorAll('.card, .btn').forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(20px)';
  });

  setTimeout(() => {
    document.querySelectorAll('.card, .btn').forEach((el, i) => {
      setTimeout(() => {
        el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, 100 * i);
    });
  }, 300);
});
</script>
{% endblock %}